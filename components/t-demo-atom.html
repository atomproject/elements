<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/t-device-view/t-device-view.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/t-button/t-button.html">
<link rel="import" href="t-component-panel/t-component-panel.html">
<link rel="import" href="t-component-code">
<link rel="import" href="t-device-toggle">

<dom-module id="t-demo-atom">
	<template>
    <style>
      :host {
        display: block;
        position: relative;
        height: 100%;
      }

      #filterDrawerPanel [main] {
        background-color: #fff;
      }

      #filterDrawerPanel [drawer] {
        border-left: 1px solid;
        border-bottom: 1px solid;
        border-color: var(--grey-two);
      }

      .right-panel {
        height: 100%;
      }

      .header {
        height: 45px;
      }

      .body {
        max-height: calc(100% - 45px);
        margin: 10px 0;
        overflow: auto;
      }

      div[main] {
        padding: 8px 16px;
      }

      t-device-toggle {
        border-bottom: 1px solid;
        border-color: var(--grey-two);
      }

      t-component-code {
        margin-top: 20px;
      }

      hr {
        border: none;
        border-bottom: 1px solid;
        border-color: var(--grey-one);
      }
    </style>

  	<paper-drawer-panel id="filterDrawerPanel" class="main-drawer-panel"
      transition disable-swipe right-drawer responsive-width="1100px"
      main drawer-width="{{filterWidth}}" on-paper-responsive-change="_setWidth"
      drawer-toggle-attribute="filter-toggle">

        <div class="layout vertical" selected main>
          <div class="header">
            <t-button ico="filter-list" only-icon filter-toggle paper-drawer-toggle>
            </t-button>
          </div>
          <div class="body" active$="{{activated}}" >
            <device-view device="{{device}}" landscape="{{landscape}}">
              <iframe id="demo" src="{{demoFile}}" frameborder="0"></iframe>
            </device-view>
            <hr>
            <t-component-code id="code" component-name="[[componentName]]"></t-component-code>
          </div>
        </div>
        <div drawer>
          <div class="right-panel layout vertical">
            <t-device-toggle device="{{device}}" landscape="{{landscape}}">
            </t-device-toggle>
            <div style="overflow:auto;">
              <t-component-panel
                on-property-changed="propertyChanged"
                property-source="{{propertiesFile}}"
                component="{{componentName}}">
              </t-component-panel>
            </div>
          </div>
        </div>

    </paper-drawer-panel>
  </template>
  <script>
    Polymer({

      is: 't-demo-atom',

      properties:{
        /*filter width for handling responsive*/
        filterWidth: String,
        propertiesFile: String,
        componentName: String,
        demoFile: String,

        landscape: {
          type: Boolean,
          value: false,
          notify: true
        },

        device: {
          type: String,
          value: 'laptop',
          notify: true
        },

        /*activated the  toggle of code section*/
        activated:{
          type:Boolean,
          value:false,
          reflectToAttribute:true
        }
      },

      //initialized in the ready callback
      _queue: undefined,
      //initialized when the element can be found in the iframe
      //
      _demoComponent: undefined,

      //listen to the load event of iframe
      listeners: {
        'demo.load': 'setDemoComponent'
      },

      ready: function() {
        this._queue = {};

        //if the load event of iframe triggers earlier than the
        //ready callback then `this.componentName` won't be available
        //so we trigger the `setDemoComponent` callback here
        if (!this._demoComponent) {
          this.setDemoComponent();
        }
      },

      //the load event is triggered twice, it shouldn't be a problem
      //but why the heck is it triggered twice?.
      setDemoComponent: function(event) {
        var iframeDoc, targetComponent;

        if (!this.componentName) {
          return;
        }

        iframeDoc = this.$.demo.contentWindow.document;
        targetComponent = iframeDoc.querySelector(this.componentName);

        if (targetComponent) {
          this._demoComponent = targetComponent;
          this.updateCode();
        }
      },

      //call this method when component to be demoed is available in DOM
      //get default property values of the element and show them as attributes
      //in the HTML code as attributes
      updateCode: function() {
        //get the custom properties of the element
        var properties = this._demoComponent.properties;
        var propertyKeys = Object.keys(properties);

        propertyKeys.forEach(function(propertyKey) {
          //get the current (default) value of the property
          var value = this._queue[propertyKey];

          //the values in queue have higher priority
          //than the values provided directly on the markup
          if (value === undefined || value === null) {
            value = this._demoComponent[propertyKey];
          } else {
            //delete the property from queue
            delete this._queue[propertyKey];
          }

          //check if the value should reflect
          if (value === 0 || value) {
            //update the targets
            this.updateTargets(propertyKey, value);
          }
        }.bind(this));
      },

      //this callback is triggered on the `property-chaned` event
      //the event is fired by the `t-component-panel`, this callback
      //queues the up the changes to apply if the component to be demoed
      //isn't available.
      propertyChanged: function(event) {
        var key, value;

        if (!event.detail) {
          return;
        }

        key = event.detail.key;
        value = event.detail.value;

        if (!this._demoComponent) {
          //if the target is not available yet then queue up
          //the values for later application
          this._queue[key] = value;
        } else {
          this.updateTargets(key, value);
        }
      },
      
      //update the changes to properties
      updateTargets: function(key, value) {
        //update the demo component itself
        this._demoComponent[key] = value;
        //update the html attributes in code
        this.$.code.set('componentAttributes.' + key, value);
      },

      //calculate the width and put value
      _setWidth:function(){
        var winWid =  window.innerWidth;

        this.filterWidth = (winWid < 600 ? '75%' : '300px');
      }
    });
  </script>
</dom-module>
